version: '3.8'

name: road-freight-platform

services:
  # ----------------------------------------
  # API Gateway & Service Discovery
  # ----------------------------------------
  consul:
    image: hashicorp/consul:1.22
    container_name: consul
    command: "agent -server -bootstrap-expect=1 -ui -client=0.0.0.0"
    ports:
      - "8500:8500"    # Consul UI & API
      - "8600:8600/udp" # Consul DNS
    networks:
      - road-freight-net

  # ----------------------------------------
  # Application Services
  # ----------------------------------------
  postgis:
    image: postgis/postgis:18-3.6
    container_name: postgis
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: road_freight_db
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql
    networks:
      - road-freight-net

  redis:
    image: redis:8.4.0-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - road-freight-net

  rabbitmq:
    image: rabbitmq:4.2.1-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"    # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - road-freight-net

  # ----------------------------------------
  # Observability Stack (O11y)
  # ----------------------------------------
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.140.1
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
      - "8889:8889" # Prometheus metrics exporter
    networks:
      - road-freight-net
    depends_on:
      - prometheus
      - tempo
      - loki

  prometheus:
    image: prom/prometheus:v3.7.3
    container_name: prometheus
    command: ["--config.file=/etc/prometheus.yaml"]
    volumes:
      - ./prometheus.yaml:/etc/prometheus.yaml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090" # Prometheus UI
    networks:
      - road-freight-net

  tempo:
    image: grafana/tempo:2.9.0
    container_name: tempo
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./tempo.yaml:/etc/tempo.yaml
      - tempo-data:/var/tempo
    # No ports exposed to host, only internal communication from otel-collector
    networks:
      - road-freight-net

  loki:
    image: grafana/loki:3.6.2
    container_name: loki
    command: ["-config.file=/etc/loki/loki.yaml"]
    volumes:
      - ./loki.yaml:/etc/loki/loki.yaml
      - loki-data:/loki
    ports:
      - "3100:3100"

  grafana:
    image: grafana/grafana:12.3.0
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - ./grafana-datasources.yaml:/etc/grafana/provisioning/datasources/grafana-datasources.yaml
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000" # Grafana UI
    networks:
      - road-freight-net
    depends_on:
      - prometheus
      - loki
      - tempo

# ----------------------------------------
# Volumes & Networks
# ----------------------------------------
volumes:
  postgres-data:
  redis-data:
  rabbitmq-data:
  prometheus-data:
  tempo-data:
  loki-data:
  grafana-data:

networks:
  road-freight-net:
    driver: bridge